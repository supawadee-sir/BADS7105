create or replace model `crmtest-308203.supermarket.supermarket_ss_clusters`
OPTIONS(model_type='kmeans', num_clusters=5) 
AS (
SELECT TOTAL_VISIT,
    TOTAL_SPEND,
    TOTAL_UNIT,
    TOTAL_SPEND/TOTAL_VISIT AS SPEND_PER_VISIT,
    TOTAL_UNIT/TOTAL_VISIT AS UNIT_PER_VISIT,
    TOTAL_PRODUCT/TOTAL_VISIT AS PROD_PER_VISIT
FROM (
    SELECT 
        COUNT(DISTINCT BASKET_ID) AS TOTAL_VISIT,
        SUM(SPEND) AS TOTAL_SPEND,
        COUNT(DISTINCT PROD_CODE ) AS TOTAL_PRODUCT,
        SUM(QUANTITY) AS TOTAL_UNIT
FROM `crmtest-308203.supermarket.supermarket_ss`
WHERE CUST_CODE IS NOT NULL
GROUP BY CUST_CODE) 
)
